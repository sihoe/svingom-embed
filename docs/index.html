<script>
(function(){
  const root = document.getElementById("mapMaster");
  const err = document.getElementById("routeError");
  const titleEl = document.getElementById("routeTitle");

  const params = new URLSearchParams(window.location.search);
  const routeId = (params.get("route") || "").trim();

  if (!routeId){
    err.style.display = "block";
    err.innerHTML =
      "Mangler <code>?route=...</code> i URL.<br><br>" +
      "Eksempel: <code>?route=smadoldalen-rundt</code>";
    return;
  }

  root.setAttribute("data-route-id", routeId);

  const ROUTES_URL = root.getAttribute("data-routes-url");

  function cacheBust(url){
    const sep = url.includes("?") ? "&" : "?";
    return url + sep + "v=" + Date.now() + "-" + Math.random().toString(16).slice(2);
  }

  function getRouteLinkEl(){
    return document.getElementById("routeLink");
  }

  function setRouteLink(url){
    const a = getRouteLinkEl();
    if (!a) return false;
    a.href = url || "https://www.svingom.no";
    a.target = "_top";
    a.rel = "noopener";
    return true;
  }

  function findRouteObj(data, id){
    if (Array.isArray(data?.routes)) return data.routes.find(r => r?.id === id) || null;
    if (Array.isArray(data)) return data.find(r => r?.id === id) || null;
    if (data && typeof data === "object" && !Array.isArray(data)){
      if (data[id]) return data[id];
      return Object.values(data).find(r => r?.id === id) || null;
    }
    return null;
  }

  async function applyTitleAndLink(){
    const niceFallback = routeId
      .replace(/-/g, " ")
      .replace(/(^|\s)\S/g, s => s.toUpperCase());

    try{
      const res = await fetch(cacheBust(ROUTES_URL), { cache: "no-store" });
      if (!res.ok) throw new Error("Kunne ikke hente routes402.json");
      const data = await res.json();

      const routeObj = findRouteObj(data, routeId);
      if (!routeObj){
        console.warn("[embed] Fant ikke routeObj for id:", routeId);
        titleEl.textContent = niceFallback;
        document.title = niceFallback;
        setRouteLink("https://www.svingom.no");
        return;
      }

      const nameNo =
        routeObj?.name?.no ??
        (typeof routeObj?.name === "string" ? routeObj.name : null);

      const pageUrl =
        (typeof routeObj?.pageUrl === "string" ? routeObj.pageUrl : null) ??
        (typeof routeObj?.pageUrl?.no === "string" ? routeObj.pageUrl.no : null);

      const title = nameNo ? String(nameNo) : niceFallback;
      titleEl.textContent = title;
      document.title = title;

      if (!pageUrl){
        console.warn("[embed] pageUrl mangler for id:", routeId, routeObj);
      }
      setRouteLink(pageUrl || "https://www.svingom.no");

    } catch (e){
      console.error("[embed] Feil i applyTitleAndLink:", e);
      titleEl.textContent = niceFallback;
      document.title = niceFallback;
      setRouteLink("https://www.svingom.no");
    }
  }

  // Kjør én gang med en gang
  applyTitleAndLink();

  // Kjør igjen etter at master kan ha tuklet med DOM
  setTimeout(applyTitleAndLink, 800);
  setTimeout(applyTitleAndLink, 2000);

  // Overvåk DOM: hvis routeLink blir “reset” eller byttet ut, sett den igjen
  const mo = new MutationObserver(() => {
    // Ikke fetch på hver mutation, bare sørg for at href ikke står igjen på forsiden
    const a = getRouteLinkEl();
    if (a && a.href && a.href.includes("svingom.no/") && a.href.endsWith("svingom.no/")) {
      // hvis den ble reset til forsiden, re-apply (med fetch)
      applyTitleAndLink();
    }
  });
  mo.observe(document.body, { childList: true, subtree: true });

  // ---- Mobil-kollaps (samme som før, men uten å røre linken) ----
  const openBtn = root.querySelector(".svingom-open-panel-btn");
  const mapEl = root.querySelector(".route-map");
  let collapsed = false;

  function isMobile(){
    return window.matchMedia && window.matchMedia("(max-width: 900px)").matches;
  }

  function setCollapsed(on){
    collapsed = !!on;
    if (isMobile()){
      root.classList.toggle("svingom-popup-collapsed", collapsed);
    } else {
      root.classList.remove("svingom-popup-collapsed");
      collapsed = false;
    }
    syncCollapseButton();
  }

  function ensureCollapseButton(){
    if (!isMobile()) return null;
    const popup = root.querySelector(".route-popup");
    if (!popup) return null;

    if (getComputedStyle(popup).position === "static") popup.style.position = "relative";

    let btn = popup.querySelector(".svingom-collapse-btn");
    if (!btn){
      btn = document.createElement("button");
      btn.type = "button";
      btn.className = "svingom-collapse-btn";
      btn.setAttribute("aria-label", "Skjul POI og nøkkelinformasjon");
      btn.textContent = "×";
      btn.addEventListener("click", (e)=>{
        e.preventDefault();
        setCollapsed(true);
      });
      popup.appendChild(btn);
    }
    return btn;
  }

  function syncCollapseButton(){
    const btn = ensureCollapseButton();
    if (!btn) return;
    btn.style.display = (isMobile() && !collapsed) ? "inline-flex" : "none";
  }

  openBtn?.addEventListener("click", (e)=>{
    e.preventDefault();
    setCollapsed(false);
  });

  mapEl?.addEventListener("click", (ev)=>{
    if (!isMobile() || !collapsed) return;
    const hit = ev.target && (
      ev.target.closest?.(".leaflet-marker-icon") ||
      ev.target.closest?.(".leaflet-interactive") ||
      ev.target.closest?.(".leaflet-marker-pane")
    );
    if (hit) setCollapsed(false);
  }, true);

  window.addEventListener("resize", ()=>{
    if (!isMobile()) setCollapsed(false);
    else root.classList.toggle("svingom-popup-collapsed", collapsed);
    syncCollapseButton();
  }, { passive:true });

  setCollapsed(false);
  setTimeout(syncCollapseButton, 200);

  // ---- Last master ----
  const s = document.createElement("script");
  s.src = "https://cdn.jsdelivr.net/gh/sihoe/kartdata@main/js/route_map_master214.js";
  s.defer = true;
  document.head.appendChild(s);
})();
</script>
